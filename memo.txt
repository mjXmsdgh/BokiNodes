リアルタイム財務諸表 作成計画
いきなり完璧なものを作るのではなく、段階的に機能を育てていくアプローチがおすすめです。

## フェーズ1: 基礎設計とデータ準備
目的: 財務諸表を作るために必要な「情報」をデータモデルに追加し、計算の土台を整える。

### 1. 勘定科目に「分類」を追加する

現状の課題: 今のAccount（勘定科目）データには、「現金」や「売上」という名前はあっても、それが「資産」なのか「収益」なのか、コンピュータは判断できません。
やること:
1.  **`scripts/data/account.gd` の修正**:
    -   `Account` リソースのスクリプトに、財務諸表の分類を保持するためのプロパティ（例: `category`）を追加します。
    -   分類は、簿記の基本である5大要素「資産、負債、純資産、収益、費用」をenumで定義すると管理しやすくなります。
2.  **既存勘定科目データへの設定**:
    -   `ledger.gd` などで初期化している既存の勘定科目データ（現金、借入金、資本金など）すべてに、この新しい分類情報を設定します。
    -   例: `Account.new("現金", Account.Category.ASSET)`

### 2. 財務諸表UIの設計

やること:
1.  **ワイヤーフレーム作成**:
    -   いきなりGodot上で作り始めるのではなく、まず紙やデザインツールで簡単なワイヤーフレーム（骨組み図）を描きます。
    -   **表示場所**: `main.tscn` の `UILayer` 内に、他のUI（`GameUI`, `TutorialUI`）と並列で配置することを想定します。最初はボタンで表示/非表示を切り替えるのがシンプルです。
    -   **表示内容**: 最初はごくシンプルなサマリー情報に絞ります。
        -   **貸借対照表(B/S)**:
            -   資産合計: ￥〇〇
            -   負債合計: ￥〇〇
            -   純資産合計: ￥〇〇
            -   （貸借一致の確認: 資産合計 = 負債合計 + 純資産合計）
        -   **損益計算書(P/L)**:
            -   収益合計: ￥〇〇
            -   費用合計: ￥〇〇
            -   当期純利益: ￥〇〇 (収益 - 費用)

## フェーズ2: 静的な表示の実装
目的: まずは「ある一時点」の財務諸表を正しく表示できるようにする。まだリアルタイムで動かなくてOK。

### 1. 集計ロジックの実装

やること:
1.  **`FinancialStatementManager` の作成**:
    -   財務諸表の計算ロジックは、新しいシングルトン `FinancialStatementManager` に持たせます。
    -   `scripts/singletons/financial_statement_manager.gd` というスクリプトファイルを作成し、Godotのプロジェクト設定でオートロード（シングルトン）として登録します。
2.  **計算ロジックの実装**:
    -   `FinancialStatementManager` 内に、B/SとP/Lの各項目を計算する関数を実装します。
    -   この関数は、`Ledger` シングルトン (`scripts/singletons/ledger.gd`) にアクセスして、全勘定科目のリストを取得します。
    -   取得したリストをループ処理し、フェーズ1で追加した `category` を元に各分類（資産、負債など）の残高を合計します。
    -   **重要**: B/Sの「純資産合計」には、P/Lで計算した「当期純利益」（収益合計 - 費用合計）も含まれることを考慮して計算式を組み立てます。（純資産合計 = 元々の純資産 + 当期純利益）

### 2. UIの作成と表示

やること:
1.  **UIシーンの作成**:
    -   `scenes/ui/financial_statement_panel.tscn` という新しいUIシーンを作成します。
    -   ルートノードは `PanelContainer` とし、内部に `VBoxContainer` や `Label` を配置して、設計したレイアウトを組みます。
2.  **メインシーンへの統合**:
    -   `main.tscn` を開き、`UILayer` ノードの子として `financial_statement_panel.tscn` のインスタンスを追加します。
3.  **データ表示処理**:
    -   `FinancialStatementPanel` にアタッチするスクリプト (`scripts/ui/financial_statement_panel.gd`) を作成します。
    -   このスクリプトが `FinancialStatementManager` を呼び出して計算結果を取得し、シーン内の各 `Label` のテキストを更新する処理を実装します。
    -   この時点では、取引をしても数値はまだ更新されません。まずはUIが表示されることだけを目指します。

## フェーズ3: リアルタイム更新の実装
目的: 取引アニメーションと連動して、財務諸表の数値がリアルタイムで変化するようにする。BokiNodesの体験が飛躍的に向上する核心部分です。

### 1. 更新の「きっかけ」を接続する

現状の仕組み: `Ledger` は取引を実行すると `account_updated` シグナルを発行しています。これは「勘定科目の残高が変わったよ！」という合図です。
やること:
1.  **シグナル接続**:
    -   `FinancialStatementManager` の `_ready()` 関数内で、`Ledger` の `account_updated` シグナルを自身の関数（例: `_on_account_updated`）に接続（connect）します。
2.  **再計算と通知**:
    -   シグナルを受け取った `_on_account_updated` 関数内で、再度「集計ロジック」を実行し、計算結果を更新します。
    -   `FinancialStatementManager` に、計算結果が更新されたことを示す独自のシグナル（例: `statements_updated(new_data)`) を定義します。再計算後にこのシグナルを発行します。
3.  **UI更新**:
    -   `FinancialStatementPanel` のスクリプトで、`FinancialStatementManager` の `statements_updated` シグナルを接続し、受け取ったデータで `Label` の表示を更新する処理を実装します。

### 2. 変化を分かりやすくする演出を追加する（オプション）

やること:
-   数値がただ切り替わるだけだと、どこが変化したか見逃しがちです。
-   `Tween` や `AnimationPlayer` を使い、数値が更新された `Label` を一瞬だけ光らせたり、色を変えたり、少しだけ大きくしたりする簡単なアニメーションを追加します。
-   これにより、「ああ、現金が減って、資産合計がこう変わったのか！」という繋がりが、より直感的に理解できるようになります。

## フェーズ4: 詳細化と改善
目的: シンプルな財務諸表を、より実践的な形式に近づけていく。

### 1. 階層構造の導入

やること:
-   「資産合計」だけでなく、その内訳である「流動資産」「固定資産」などを表示できるようにします。
-   そのためには、フェーズ1で追加した `category` を、より詳細な分類（例: `資産 > 流動資産`）が可能なデータ構造に拡張する必要があります。
-   UIも、`Tree` ノードを使うか、`VBoxContainer` とインデント（`MarginContainer`など）を組み合わせて階層構造を表現できるように改良します。

### 2. キャッシュ・フロー計算書(C/F)の検討

やること:
-   B/S、P/Lに慣れてきたユーザーのために、第3の財務諸表であるキャッシュ・フロー計算書（現金の動きだけに着目した表）の追加を検討します。これは上級者向けの機能になります。

この計画に沿って進めることで、無理なく、しかし着実に「リアルタイム財務諸表」という魅力的な機能を実現できるはずです。まずはフェーズ1の「勘定科目の分類」から手をつけるのが良いスタートになるでしょう。頑張ってください！